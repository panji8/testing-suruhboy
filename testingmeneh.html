<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Tagihan Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .panel-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title i {
            color: #667eea;
        }
        
        .week-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            background: #f8f9fd;
            padding: 15px;
            border-radius: 8px;
        }
        
        .week-label {
            font-weight: 600;
            color: #555;
        }
        
        select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            min-width: 200px;
            background: white;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .invoice-table th {
            background: #f8f9fd;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #eaeaea;
        }
        
        .invoice-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .invoice-table tr:hover {
            background: #f9f9ff;
        }
        
        .invoice-table tr:last-child td {
            border-bottom: none;
        }
        
        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status.paid {
            background: #d4f8e8;
            color: #10b981;
        }
        
        .status.unpaid {
            background: #fee2e2;
            color: #ef4444;
        }
        
        .status.partial {
            background: #fef3c7;
            color: #d97706;
        }
        
        .currency {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        .total-row {
            background: #f8f9fd;
            font-weight: 700;
            font-size: 16px;
        }
        
        .total-row td {
            padding: 18px 15px;
        }
        
        .payment-form {
            display: grid;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-size: 14px;
            color: #555;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-input {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .submit-btn {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }
        
        .notification.success {
            background: #d4f8e8;
            color: #10b981;
            border: 1px solid #a7f3d0;
            display: block;
        }
        
        .notification.error {
            background: #fee2e2;
            color: #ef4444;
            border: 1px solid #fecaca;
            display: block;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            text-align: center;
        }
        
        .card-value {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
            margin: 10px 0;
        }
        
        .card-label {
            color: #666;
            font-size: 14px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        
        .empty-state i {
            font-size: 40px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: #888;
            font-size: 14px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> Dashboard Tagihan Agent</h1>
            <div class="subtitle">Monitoring pembayaran biaya admin per minggu</div>
        </header>
        
        <!-- NOTIFICATION -->
        <div id="notification" class="notification"></div>
        
        <!-- WEEK SELECTOR -->
        <div class="week-selector">
            <div class="week-label">Pilih Periode:</div>
            <select id="weekSelect">
                <option value="18-24 Jan 2025">18-24 Jan 2025</option>
                <option value="25-31 Jan 2025" selected>25-31 Jan 2025</option>
                <option value="1-7 Feb 2025">1-7 Feb 2025</option>
                <option value="8-14 Feb 2025">8-14 Feb 2025</option>
                <option value="15-21 Feb 2025">15-21 Feb 2025</option>
                <option value="22-28 Feb 2025">22-28 Feb 2025</option>
                <option value="1-7 Mar 2025">1-7 Mar 2025</option>
            </select>
            <button class="submit-btn" onclick="refreshData()" style="padding: 10px 20px;">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        
        <!-- SUMMARY CARDS -->
        <div class="summary-cards">
            <div class="card">
                <div class="card-label">Total Agent</div>
                <div class="card-value" id="totalAgents">8</div>
            </div>
            <div class="card">
                <div class="card-label">Total Tagihan</div>
                <div class="card-value" id="totalInvoice">Rp2.450.000</div>
            </div>
            <div class="card">
                <div class="card-label">Sudah Dibayar</div>
                <div class="card-value" id="totalPaid">Rp1.850.000</div>
            </div>
            <div class="card">
                <div class="card-label">Tunggakan</div>
                <div class="card-value" id="totalDue">Rp600.000</div>
            </div>
        </div>
        
        <!-- DASHBOARD GRID -->
        <div class="dashboard-grid">
            <!-- PANEL KIRI: DAFTAR TAGIHAN -->
            <div class="panel">
                <div class="panel-title">
                    <i class="fas fa-file-invoice-dollar"></i> Daftar Tagihan
                    <span style="margin-left: auto; font-size: 14px; color: #667eea;" id="selectedWeek">25-31 Jan 2025</span>
                </div>
                
                <div class="table-container">
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th>WhatsApp</th>
                                <th>Biaya Admin</th>
                                <th>Status</th>
                                <th>Sisa</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceTable">
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="2">TOTAL</td>
                                <td class="currency" id="totalAdmin">Rp245.000</td>
                                <td></td>
                                <td class="currency" id="totalRemaining">Rp60.000</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div style="margin-top: 20px; font-size: 13px; color: #888; text-align: center;">
                    <i class="fas fa-info-circle"></i> Total Order = Biaya Admin √ó 10
                </div>
            </div>
            
            <!-- PANEL KANAN: INPUT PEMBAYARAN -->
            <div class="panel">
                <div class="panel-title">
                    <i class="fas fa-money-bill-wave"></i> Input Pembayaran
                </div>
                
                <div class="payment-form">
                    <div class="form-group">
                        <label class="form-label">Pilih Agent:</label>
                        <select class="form-input" id="agentSelect">
                            <option value="">Pilih agent...</option>
                            <!-- Agent options akan diisi oleh JavaScript -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Minggu:</label>
                        <select class="form-input" id="paymentWeekSelect">
                            <option value="18-24 Jan 2025">18-24 Jan 2025</option>
                            <option value="25-31 Jan 2025" selected>25-31 Jan 2025</option>
                            <option value="1-7 Feb 2025">1-7 Feb 2025</option>
                            <option value="8-14 Feb 2025">8-14 Feb 2025</option>
                            <option value="15-21 Feb 2025">15-21 Feb 2025</option>
                            <option value="22-28 Feb 2025">22-28 Feb 2025</option>
                            <option value="1-7 Mar 2025">1-7 Mar 2025</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Total Tagihan:</label>
                            <input type="text" class="form-input" id="totalInvoiceInput" readonly value="Rp0">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Jumlah Bayar (Rp):</label>
                            <input type="number" class="form-input" id="paymentAmount" 
                                   placeholder="Masukkan jumlah" min="0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Keterangan (Opsional):</label>
                        <input type="text" class="form-input" id="paymentNotes" 
                               placeholder="Contoh: Transfer BCA, Cash, dll">
                    </div>
                    
                    <div class="loading" id="loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Menyimpan data...</p>
                    </div>
                    
                    <button type="button" class="submit-btn" id="submitPaymentBtn" onclick="submitPayment()">
                        <i class="fas fa-save"></i> Simpan Pembayaran
                    </button>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <div class="panel-title" style="font-size: 18px; margin-bottom: 15px;">
                        <i class="fas fa-history"></i> Riwayat Input
                    </div>
                    <div id="paymentHistory">
                        <!-- Riwayat akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Dashboard Tagihan Agent &copy; 2025 | Data dummy untuk demonstrasi</p>
            <p style="font-size: 12px; margin-top: 5px;">
                Terakhir update: <span id="lastUpdate">-</span>
            </p>
        </footer>
    </div>

    <script>
        // DATA DUMMY
        const dummyData = {
            agents: [
                { id: 1, name: "Diar", whatsapp: "081234567890", adminFee: 35000, paid: 35000, status: "paid" },
                { id: 2, name: "Restu", whatsapp: "082345678901", adminFee: 45000, paid: 30000, status: "partial" },
                { id: 3, name: "Fajar", whatsapp: "083456789012", adminFee: 52000, paid: 0, status: "unpaid" },
                { id: 4, name: "Kharisma", whatsapp: "084567890123", adminFee: 28000, paid: 28000, status: "paid" },
                { id: 5, name: "Agung", whatsapp: "085678901234", adminFee: 38000, paid: 20000, status: "partial" },
                { id: 6, name: "Defita", whatsapp: "086789012345", adminFee: 42000, paid: 42000, status: "paid" },
                { id: 7, name: "Lutfi Majid", whatsapp: "087890123456", adminFee: 31000, paid: 0, status: "unpaid" },
                { id: 8, name: "Akhmad Rifki", whatsapp: "088901234567", adminFee: 24000, paid: 24000, status: "paid" }
            ],
            
            paymentHistory: [
                { agent: "Diar", week: "25-31 Jan 2025", amount: 35000, notes: "Transfer BCA", date: "2025-01-30 14:30" },
                { agent: "Restu", week: "25-31 Jan 2025", amount: 30000, notes: "Cash meeting", date: "2025-01-29 11:20" },
                { agent: "Kharisma", week: "25-31 Jan 2025", amount: 28000, notes: "Transfer BRI", date: "2025-01-28 16:45" },
                { agent: "Agung", week: "25-31 Jan 2025", amount: 20000, notes: "DP pertama", date: "2025-01-27 09:15" }
            ]
        };
        
        // APPS SCRIPT URL (GANTI DENGAN URL ANDA)
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVR8YonZVMHCqQzfkFUU6sVxnw7nKQ4rG864R-jNoZ80oHklvqM5wPji3xfHbzUCjVVg/exec';
        
        // Format currency
        function formatCurrency(amount) {
            if (amount === 0) return 'Rp0';
            return 'Rp' + amount.toLocaleString('id-ID');
        }
        
        // Format WhatsApp number
        function formatWhatsApp(number) {
            if (!number) return '-';
            const clean = number.replace(/\D/g, '');
            return clean.substring(0, 4) + '-' + 
                   clean.substring(4, 8) + '-' + 
                   clean.substring(8);
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    notif.style.display = 'none';
                }, 5000);
            }
        }
        
        // Calculate summary
        function calculateSummary(agents) {
            const totalAgents = agents.length;
            const totalInvoice = agents.reduce((sum, agent) => sum + agent.adminFee, 0);
            const totalPaid = agents.reduce((sum, agent) => sum + agent.paid, 0);
            const totalDue = totalInvoice - totalPaid;
            
            return { totalAgents, totalInvoice, totalPaid, totalDue };
        }
        
        // Render invoice table
        function renderInvoiceTable(agents) {
            const tbody = document.getElementById('invoiceTable');
            tbody.innerHTML = '';
            
            agents.forEach(agent => {
                const remaining = agent.adminFee - agent.paid;
                const statusClass = agent.status;
                const statusText = agent.status === 'paid' ? 'Lunas' : 
                                  agent.status === 'partial' ? 'Sebagian' : 'Belum Bayar';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${agent.name}</strong></td>
                    <td>${formatWhatsApp(agent.whatsapp)}</td>
                    <td class="currency">${formatCurrency(agent.adminFee)}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td class="currency">${formatCurrency(remaining)}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Update totals
            const summary = calculateSummary(agents);
            document.getElementById('totalAdmin').textContent = formatCurrency(summary.totalInvoice);
            document.getElementById('totalRemaining').textContent = formatCurrency(summary.totalDue);
        }
        
        // Render summary cards
        function renderSummaryCards(agents) {
            const summary = calculateSummary(agents);
            
            document.getElementById('totalAgents').textContent = summary.totalAgents;
            document.getElementById('totalInvoice').textContent = formatCurrency(summary.totalInvoice * 10); // Total order
            document.getElementById('totalPaid').textContent = formatCurrency(summary.totalPaid);
            document.getElementById('totalDue').textContent = formatCurrency(summary.totalDue);
        }
        
        // Populate agent dropdown
        function populateAgentDropdown(agents) {
            const select = document.getElementById('agentSelect');
            select.innerHTML = '<option value="">Pilih agent...</option>';
            
            agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.name;
                option.textContent = `${agent.name} (${formatCurrency(agent.adminFee)})`;
                select.appendChild(option);
            });
            
            // Add change listener
            select.addEventListener('change', function() {
                const selectedAgent = agents.find(a => a.name === this.value);
                if (selectedAgent) {
                    document.getElementById('totalInvoiceInput').value = formatCurrency(selectedAgent.adminFee);
                    document.getElementById('paymentAmount').max = selectedAgent.adminFee * 2;
                } else {
                    document.getElementById('totalInvoiceInput').value = 'Rp0';
                }
            });
        }
        
        // Render payment history
        function renderPaymentHistory() {
            const container = document.getElementById('paymentHistory');
            
            if (dummyData.paymentHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>Belum ada riwayat pembayaran</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="max-height: 200px; overflow-y: auto;">';
            
            dummyData.paymentHistory.forEach(payment => {
                html += `
                    <div style="padding: 12px; margin-bottom: 10px; background: #f8f9fd; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>${payment.agent}</strong>
                                <div style="font-size: 12px; color: #666;">${payment.week}</div>
                            </div>
                            <div style="text-align: right;">
                                <strong style="color: #10b981;">${formatCurrency(payment.amount)}</strong>
                                <div style="font-size: 11px; color: #888;">${payment.date}</div>
                            </div>
                        </div>
                        ${payment.notes ? `<div style="font-size: 12px; color: #777; margin-top: 5px;">üìù ${payment.notes}</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Refresh data
        function refreshData() {
            const selectedWeek = document.getElementById('weekSelect').value;
            document.getElementById('selectedWeek').textContent = selectedWeek;
            
            // For demo, just recalculate with current data
            renderInvoiceTable(dummyData.agents);
            renderSummaryCards(dummyData.agents);
            populateAgentDropdown(dummyData.agents);
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('id-ID');
            
            showNotification(`Data untuk periode ${selectedWeek} diperbarui`, 'success');
        }
        
        // Submit payment to Google Sheets
        async function submitPayment() {
            const agent = document.getElementById('agentSelect').value;
            const week = document.getElementById('paymentWeekSelect').value;
            const amount = document.getElementById('paymentAmount').value;
            const notes = document.getElementById('paymentNotes').value;
            
            // Validation
            if (!agent || !amount || amount <= 0) {
                showNotification('Harap pilih agent dan isi jumlah pembayaran!', 'error');
                return;
            }
            
            // Get admin fee for selected agent
            const selectedAgent = dummyData.agents.find(a => a.name === agent);
            if (!selectedAgent) {
                showNotification('Agent tidak ditemukan!', 'error');
                return;
            }
            
            // Show loading
            const loading = document.getElementById('loading');
            const submitBtn = document.getElementById('submitPaymentBtn');
            loading.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            
            try {
                // Prepare data for Google Sheets
                const paymentData = {
                    agent: agent,
                    week: week,
                    amount: parseInt(amount),
                    notes: notes,
                    total_admin: selectedAgent.adminFee,
                    timestamp: new Date().toISOString()
                };
                
                // Send to Google Sheets
                const params = new URLSearchParams(paymentData);
                const url = `${APPS_SCRIPT_URL}?${params.toString()}`;
                
                console.log('Sending to:', url);
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    // Update dummy data (for demo)
                    const agentIndex = dummyData.agents.findIndex(a => a.name === agent);
                    if (agentIndex !== -1) {
                        const newPaid = dummyData.agents[agentIndex].paid + parseInt(amount);
                        dummyData.agents[agentIndex].paid = newPaid;
                        
                        // Update status
                        if (newPaid >= dummyData.agents[agentIndex].adminFee) {
                            dummyData.agents[agentIndex].status = 'paid';
                        } else if (newPaid > 0) {
                            dummyData.agents[agentIndex].status = 'partial';
                        }
                        
                        // Add to history
                        dummyData.paymentHistory.unshift({
                            agent: agent,
                            week: week,
                            amount: parseInt(amount),
                            notes: notes || '-',
                            date: new Date().toLocaleString('id-ID')
                        });
                    }
                    
                    // Update UI
                    refreshData();
                    renderPaymentHistory();
                    
                    // Clear form
                    document.getElementById('paymentAmount').value = '';
                    document.getElementById('paymentNotes').value = '';
                    
                    showNotification(`‚úÖ Pembayaran ${formatCurrency(amount)} berhasil disimpan!`, 'success');
                    
                } else {
                    throw new Error(result.message || 'Gagal menyimpan');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showNotification(`‚ö†Ô∏è ${error.message}. Data disimpan secara lokal.`, 'error');
                
                // Fallback: save locally
                const localPayments = JSON.parse(localStorage.getItem('localPayments') || '[]');
                localPayments.push({
                    agent, week, amount, notes,
                    savedAt: new Date().toISOString(),
                    isLocal: true
                });
                localStorage.setItem('localPayments', JSON.stringify(localPayments));
                
            } finally {
                // Hide loading
                loading.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Pembayaran';
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial data
            refreshData();
            renderPaymentHistory();
            
            // Set last update
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('id-ID');
            
            // Test connection to Google Sheets
            fetch(APPS_SCRIPT_URL + '?test=1')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('‚úÖ Connected to Google Sheets API');
                    }
                })
                .catch(error => {
                    console.warn('‚ö†Ô∏è Google Sheets connection:', error);
                });
        });
    </script>
</body>
</html>
