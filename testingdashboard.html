<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Tagihan Agent - Real Data</title>
    <style>
        /* CSS sama seperti sebelumnya... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .panel-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title i {
            color: #667eea;
        }
        
        .week-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            background: #f8f9fd;
            padding: 15px;
            border-radius: 8px;
        }
        
        .week-label {
            font-weight: 600;
            color: #555;
        }
        
        select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            min-width: 200px;
            background: white;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .invoice-table th {
            background: #f8f9fd;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #eaeaea;
        }
        
        .invoice-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .invoice-table tr:hover {
            background: #f9f9ff;
        }
        
        .invoice-table tr:last-child td {
            border-bottom: none;
        }
        
        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status.paid {
            background: #d4f8e8;
            color: #10b981;
        }
        
        .status.unpaid {
            background: #fee2e2;
            color: #ef4444;
        }
        
        .status.partial {
            background: #fef3c7;
            color: #d97706;
        }
        
        .status.overpaid {
            background: #dbeafe;
            color: #3b82f6;
        }
        
        .currency {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        .total-row {
            background: #f8f9fd;
            font-weight: 700;
            font-size: 16px;
        }
        
        .total-row td {
            padding: 18px 15px;
        }
        
        .payment-form {
            display: grid;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-size: 14px;
            color: #555;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-input {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .submit-btn {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }
        
        .notification.success {
            background: #d4f8e8;
            color: #10b981;
            border: 1px solid #a7f3d0;
            display: block;
        }
        
        .notification.error {
            background: #fee2e2;
            color: #ef4444;
            border: 1px solid #fecaca;
            display: block;
        }
        
        .notification.info {
            background: #dbeafe;
            color: #3b82f6;
            border: 1px solid #bfdbfe;
            display: block;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            text-align: center;
        }
        
        .card-value {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
            margin: 10px 0;
        }
        
        .card-label {
            color: #666;
            font-size: 14px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        
        .empty-state i {
            font-size: 40px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: #888;
            font-size: 14px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .data-loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        
        .payment-status-display {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            display: none;
        }
        
        .saldo-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            color: #0369a1;
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .saldo-positive {
            color: #10b981;
            font-weight: 600;
        }
        
        .saldo-negative {
            color: #ef4444;
            font-weight: 600;
        }
        
        .agent-balance {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fd;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .balance-label {
            color: #666;
        }
        
        .balance-value {
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        
        .balance-positive {
            color: #10b981;
        }
        
        .balance-negative {
            color: #ef4444;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> Dashboard Tagihan Agent</h1>
            <div class="subtitle">Data real dari Google Sheets - Tab "To Dashboard"</div>
            <div style="margin-top: 10px; font-size: 14px; opacity: 0.8;">
                <i class="fas fa-database"></i> Sheet: <strong>To Dashboard</strong> | Kolom: A (Agent), B (Admin Fee), C (Week)
            </div>
        </header>
        
        <!-- NOTIFICATION -->
        <div id="notification" class="notification"></div>
        
        <!-- LOADING DATA -->
        <div id="dataLoading" class="data-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Memuat data dari Google Sheets...</p>
        </div>
        
        <!-- DASHBOARD CONTENT -->
        <div id="dashboardContent" style="display: none;">
            <!-- WEEK SELECTOR -->
            <div class="week-selector">
                <div class="week-label">Pilih Periode:</div>
                <select id="weekSelect">
                    <option value="">Loading weeks...</option>
                </select>
                <button class="submit-btn" onclick="refreshData()" style="padding: 10px 20px;">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
            </div>
            
            <!-- SALDO AGENT SECTION -->
            <div id="saldoSection" class="saldo-info" style="display: none;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <i class="fas fa-wallet"></i>
                    <strong>Saldo Agent</strong>
                </div>
                <div id="saldoList">
                    <!-- Saldo agent akan ditampilkan di sini -->
                </div>
            </div>
            
            <!-- SUMMARY CARDS -->
            <div class="summary-cards">
                <div class="card">
                    <div class="card-label">Total Agent</div>
                    <div class="card-value" id="totalAgents">0</div>
                </div>
                <div class="card">
                    <div class="card-label">Total Biaya Admin</div>
                    <div class="card-value" id="totalAdmin">Rp0</div>
                </div>
                <div class="card">
                    <div class="card-label">Total Orderan</div>
                    <div class="card-value" id="totalOrders">Rp0</div>
                </div>
                <div class="card">
                    <div class="card-label">Saldo Aktif</div>
                    <div class="card-value" id="totalSaldo">Rp0</div>
                </div>
            </div>
            
            <!-- DASHBOARD GRID -->
            <div class="dashboard-grid">
                <!-- PANEL KIRI: DAFTAR TAGIHAN -->
                <div class="panel">
                    <div class="panel-title">
                        <i class="fas fa-file-invoice-dollar"></i> Daftar Tagihan
                        <span style="margin-left: auto; font-size: 14px; color: #667eea;" id="selectedWeek">-</span>
                    </div>
                    
                    <div class="table-container">
                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th>Agent</th>
                                    <th>Total Admin</th>
                                    <th>Total Order</th>
                                    <th>Dibayar</th>
                                    <th>Status</th>
                                    <th>Saldo</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceTable">
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td>TOTAL</td>
                                    <td class="currency" id="tableTotalAdmin">Rp0</td>
                                    <td class="currency" id="tableTotalOrders">Rp0</td>
                                    <td class="currency" id="tableTotalPaid">Rp0</td>
                                    <td></td>
                                    <td class="currency" id="tableTotalSaldo">Rp0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; font-size: 13px; color: #888; text-align: center;">
                        <i class="fas fa-info-circle"></i> Total Order = Biaya Admin √ó 10 | Saldo = Dibayar - Biaya Admin
                    </div>
                </div>
                
                <!-- PANEL KANAN: INPUT PEMBAYARAN -->
                <div class="panel">
                    <div class="panel-title">
                        <i class="fas fa-money-bill-wave"></i> Input Pembayaran
                    </div>
                    
                    <div class="payment-form">
                        <div class="form-group">
                            <label class="form-label">Pilih Agent:</label>
                            <select class="form-input" id="agentSelect">
                                <option value="">Loading agents...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Minggu:</label>
                            <select class="form-input" id="paymentWeekSelect">
                                <option value="">Loading weeks...</option>
                            </select>
                        </div>
                        
                        <!-- INFO AGENT -->
                        <div id="agentInfo" style="display: none;">
                            <div class="agent-balance">
                                <span class="balance-label">Biaya Admin Minggu Ini:</span>
                                <span class="balance-value" id="infoAdminFee">Rp0</span>
                            </div>
                            <div class="agent-balance">
                                <span class="balance-label">Total Sudah Dibayar:</span>
                                <span class="balance-value" id="infoTotalPaid">Rp0</span>
                            </div>
                            <div class="agent-balance">
                                <span class="balance-label">Sisa Tagihan:</span>
                                <span class="balance-value" id="infoRemaining">Rp0</span>
                            </div>
                            <div class="agent-balance">
                                <span class="balance-label">Saldo Sebelumnya:</span>
                                <span class="balance-value" id="infoPreviousSaldo">Rp0</span>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Jumlah Bayar (Rp):</label>
                                <input type="number" class="form-input" id="paymentAmount" 
                                       placeholder="Masukkan jumlah" min="0" step="5000">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Gunakan Saldo:</label>
                                <input type="number" class="form-input" id="useSaldo" 
                                       placeholder="Jumlah saldo yg digunakan" min="0" value="0">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Keterangan (Opsional):</label>
                            <input type="text" class="form-input" id="paymentNotes" 
                                   placeholder="Contoh: Transfer BCA, Cash, dll">
                        </div>
                        
                        <!-- PAYMENT STATUS DISPLAY -->
                        <div id="paymentStatusDisplay" class="payment-status-display"></div>
                        
                        <div class="loading" id="loading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Menyimpan data...</p>
                        </div>
                        
                        <button type="button" class="submit-btn" id="submitPaymentBtn" onclick="submitPayment()">
                            <i class="fas fa-save"></i> Simpan Pembayaran
                        </button>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                        <div class="panel-title" style="font-size: 18px; margin-bottom: 15px;">
                            <i class="fas fa-history"></i> Riwayat Pembayaran
                        </div>
                        <div id="paymentHistory">
                            <div class="empty-state">
                                <i class="fas fa-history"></i>
                                <p>Belum ada riwayat pembayaran</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Dashboard Tagihan Agent &copy; 2025 | Data dari Google Sheets</p>
            <p style="font-size: 12px; margin-top: 5px;">
                Terakhir update: <span id="lastUpdate">-</span> |
                Sheet: <span id="sheetStatus">‚ùå Belum terhubung</span>
            </p>
        </footer>
    </div>

    <script>
        // KONFIGURASI
        const SHEET_ID = '1fDE1tj2mYanx9FA4deMPd-OLY6CdxWHZecMsdVtkc6c';
        const ORDER_SHEET_NAME = 'To Dashboard';
        const ORDER_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${ORDER_SHEET_NAME}`;
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVR8YonZVMHCqQzfkFUU6sVxnw7nKQ4rG864R-jNoZ80oHklvqM5wPji3xfHbzUCjVVg/exec';
        
        // STATE
        let rawData = [];
        let aggregatedData = {};
        let availableWeeks = [];
        let currentWeek = '';
        let paymentHistory = {};
        let agentSaldo = {}; // Menyimpan saldo per agent
        
        // DOM Elements
        const elements = {
            dataLoading: document.getElementById('dataLoading'),
            dashboardContent: document.getElementById('dashboardContent'),
            notification: document.getElementById('notification'),
            weekSelect: document.getElementById('weekSelect'),
            selectedWeek: document.getElementById('selectedWeek'),
            agentSelect: document.getElementById('agentSelect'),
            paymentWeekSelect: document.getElementById('paymentWeekSelect'),
            paymentAmount: document.getElementById('paymentAmount'),
            useSaldo: document.getElementById('useSaldo'),
            paymentNotes: document.getElementById('paymentNotes'),
            loading: document.getElementById('loading'),
            submitPaymentBtn: document.getElementById('submitPaymentBtn'),
            invoiceTable: document.getElementById('invoiceTable'),
            totalAgents: document.getElementById('totalAgents'),
            totalAdmin: document.getElementById('totalAdmin'),
            totalOrders: document.getElementById('totalOrders'),
            totalSaldo: document.getElementById('totalSaldo'),
            tableTotalAdmin: document.getElementById('tableTotalAdmin'),
            tableTotalOrders: document.getElementById('tableTotalOrders'),
            tableTotalPaid: document.getElementById('tableTotalPaid'),
            tableTotalSaldo: document.getElementById('tableTotalSaldo'),
            paymentHistory: document.getElementById('paymentHistory'),
            lastUpdate: document.getElementById('lastUpdate'),
            sheetStatus: document.getElementById('sheetStatus'),
            agentInfo: document.getElementById('agentInfo'),
            infoAdminFee: document.getElementById('infoAdminFee'),
            infoTotalPaid: document.getElementById('infoTotalPaid'),
            infoRemaining: document.getElementById('infoRemaining'),
            infoPreviousSaldo: document.getElementById('infoPreviousSaldo'),
            paymentStatusDisplay: document.getElementById('paymentStatusDisplay'),
            saldoSection: document.getElementById('saldoSection'),
            saldoList: document.getElementById('saldoList')
        };
        
        // Format currency
        function formatCurrency(amount) {
            if (amount === 0 || amount === '0') return 'Rp0';
            if (typeof amount === 'string') {
                amount = parseFloat(amount.replace(/[^0-9-]/g, '')) || 0;
            }
            return 'Rp' + amount.toLocaleString('id-ID');
        }
        
        // Calculate total order (admin fee √ó 10)
        function calculateTotalOrder(adminFee) {
            return parseInt(adminFee) * 10;
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            elements.notification.textContent = message;
            elements.notification.className = `notification ${type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    elements.notification.style.display = 'none';
                }, 5000);
            }
        }
        
        // Parse CSV data from Google Sheets
        async function parseCSVFromSheet() {
            try {
                elements.sheetStatus.textContent = 'üîÑ Memuat data...';
                elements.sheetStatus.style.color = '#f59e0b';
                
                const response = await fetch(ORDER_CSV_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const csvText = await response.text();
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                const data = [];
                
                // Parse each line
                for (let i = 0; i < lines.length; i++) {
                    try {
                        let line = lines[i];
                        let columns = [];
                        let current = '';
                        let inQuotes = false;
                        
                        for (let char of line) {
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                columns.push(current);
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        columns.push(current);
                        
                        // Clean columns
                        columns = columns.map(col => col.replace(/^"|"$/g, '').trim());
                        
                        // Check if we have at least 3 columns (Agent, Admin Fee, Week)
                        if (columns.length >= 3) {
                            const agent = columns[0];
                            const adminFee = parseInt(columns[1].replace(/[^0-9-]/g, '')) || 0;
                            const week = columns[2];
                            
                            // Skip headers and empty rows
                            if (agent && !agent.toLowerCase().includes('agent') && 
                                !agent.toLowerCase().includes('nama') && 
                                week && week.trim() !== '') {
                                
                                data.push({
                                    agent: agent,
                                    adminFee: adminFee,
                                    week: week
                                });
                            }
                        }
                    } catch (e) {
                        console.warn('Error parsing line:', lines[i], e);
                    }
                }
                
                return data;
                
            } catch (error) {
                console.error('Error loading CSV:', error);
                throw error;
            }
        }
        
        // Aggregate data per agent per week
        function aggregateData(data) {
            const aggregated = {};
            
            data.forEach(item => {
                const { agent, adminFee, week } = item;
                
                if (!week || week.trim() === '') return;
                
                if (!aggregated[week]) {
                    aggregated[week] = {};
                }
                
                if (!aggregated[week][agent]) {
                    aggregated[week][agent] = 0;
                }
                
                aggregated[week][agent] += adminFee;
            });
            
            return aggregated;
        }
        
        // Get unique weeks and sort them
        function getSortedWeeks(aggregatedData) {
            const weeks = Object.keys(aggregatedData);
            
            // Simple sort based on week string (assuming format like "14-20 Des")
            return weeks.sort((a, b) => {
                const getDate = (weekStr) => {
                    const match = weekStr.match(/(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                };
                return getDate(a) - getDate(b);
            });
        }
        
        // Calculate agent saldo from payment history
        function calculateAgentSaldo() {
            agentSaldo = {};
            
            // Initialize all agents with 0 saldo
            Object.keys(aggregatedData).forEach(week => {
                Object.keys(aggregatedData[week]).forEach(agent => {
                    if (!agentSaldo[agent]) {
                        agentSaldo[agent] = 0;
                    }
                });
            });
            
            // Calculate saldo from payment history
            Object.values(paymentHistory).forEach(payment => {
                const agent = payment.agent;
                const week = payment.week;
                const paidAmount = payment.paidAmount || 0;
                
                // Get admin fee for this agent in this week
                const adminFee = aggregatedData[week] && aggregatedData[week][agent] ? 
                               aggregatedData[week][agent] : 0;
                
                // Calculate saldo for this payment (paid - admin fee)
                const paymentSaldo = paidAmount - adminFee;
                
                // Add to agent's total saldo
                if (!agentSaldo[agent]) agentSaldo[agent] = 0;
                agentSaldo[agent] += paymentSaldo;
            });
            
            return agentSaldo;
        }
        
        // Get data for specific week including saldo calculation
        function getWeekData(week) {
            if (!aggregatedData[week]) return [];
            
            const weekData = Object.entries(aggregatedData[week]).map(([agent, adminFee]) => {
                const totalOrder = calculateTotalOrder(adminFee);
                const paymentInfo = getPaymentInfo(agent, week);
                const paidAmount = paymentInfo ? paymentInfo.paidAmount : 0;
                const remaining = adminFee - paidAmount;
                const saldo = (paidAmount - adminFee) + (agentSaldo[agent] || 0);
                
                // Determine payment status
                let status = 'unpaid';
                if (paidAmount >= adminFee) {
                    status = saldo > 0 ? 'overpaid' : 'paid';
                } else if (paidAmount > 0) {
                    status = 'partial';
                }
                
                return {
                    agent: agent,
                    adminFee: adminFee,
                    totalOrder: totalOrder,
                    paidAmount: paidAmount,
                    remaining: remaining,
                    saldo: saldo,
                    status: status
                };
            });
            
            // Sort by admin fee (highest first)
            return weekData.sort((a, b) => b.adminFee - a.adminFee);
        }
        
        // Get payment info from localStorage
        function getPaymentInfo(agent, week) {
            const key = `${agent}_${week}`;
            return paymentHistory[key] || null;
        }
        
        // Get all payments for an agent
        function getAgentPayments(agent) {
            return Object.values(paymentHistory)
                .filter(p => p.agent === agent)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        
        // Load payment history from localStorage
        function loadPaymentHistory() {
            try {
                const saved = localStorage.getItem('agent_payment_history');
                if (saved) {
                    paymentHistory = JSON.parse(saved);
                }
            } catch (e) {
                paymentHistory = {};
            }
            
            // Calculate agent saldo
            calculateAgentSaldo();
        }
        
        // Save payment to localStorage
        function savePayment(agent, week, paidAmount, notes = '') {
            const key = `${agent}_${week}`;
            const existingPayment = paymentHistory[key];
            
            if (existingPayment) {
                // Update existing payment
                existingPayment.paidAmount += parseInt(paidAmount);
                existingPayment.notes = existingPayment.notes ? 
                    `${existingPayment.notes}; ${notes}` : notes;
                existingPayment.date = new Date().toISOString();
            } else {
                // Create new payment
                paymentHistory[key] = {
                    agent: agent,
                    week: week,
                    paidAmount: parseInt(paidAmount),
                    notes: notes,
                    date: new Date().toISOString()
                };
            }
            
            // Recalculate agent saldo
            calculateAgentSaldo();
            
            // Save to localStorage
            localStorage.setItem('agent_payment_history', JSON.stringify(paymentHistory));
            
            return paymentHistory[key];
        }
        
        // Populate week dropdowns
        function populateWeekDropdowns() {
            elements.weekSelect.innerHTML = '';
            elements.paymentWeekSelect.innerHTML = '';
            
            if (availableWeeks.length === 0) {
                elements.weekSelect.innerHTML = '<option value="">No weeks available</option>';
                elements.paymentWeekSelect.innerHTML = '<option value="">No weeks available</option>';
                return;
            }
            
            // Add options for both dropdowns
            availableWeeks.forEach((week, index) => {
                // Main week selector
                const option1 = document.createElement('option');
                option1.value = week;
                option1.textContent = week;
                if (index === availableWeeks.length - 1) {
                    option1.selected = true;
                    currentWeek = week;
                }
                elements.weekSelect.appendChild(option1);
                
                // Payment week selector
                const option2 = document.createElement('option');
                option2.value = week;
                option2.textContent = week;
                if (index === availableWeeks.length - 1) {
                    option2.selected = true;
                }
                elements.paymentWeekSelect.appendChild(option2);
            });
        }
        
        // Populate agent dropdown
        function populateAgentDropdown() {
            elements.agentSelect.innerHTML = '<option value="">Pilih agent...</option>';
            
            if (!currentWeek || !aggregatedData[currentWeek]) return;
            
            const weekAgents = Object.keys(aggregatedData[currentWeek]).sort();
            
            weekAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent;
                
                // Add saldo info to agent name
                const saldo = agentSaldo[agent] || 0;
                const saldoText = saldo !== 0 ? ` (Saldo: ${formatCurrency(saldo)})` : '';
                option.textContent = `${agent}${saldoText}`;
                
                elements.agentSelect.appendChild(option);
            });
            
            // Add change listener
            elements.agentSelect.addEventListener('change', updateAgentInfo);
            elements.paymentWeekSelect.addEventListener('change', updateAgentInfo);
            elements.paymentAmount.addEventListener('input', updatePaymentStatus);
            elements.useSaldo.addEventListener('input', updatePaymentStatus);
        }
        
        // Update agent info when selected
        function updateAgentInfo() {
            const agent = elements.agentSelect.value;
            const week = elements.paymentWeekSelect.value;
            
            if (!agent || !week || !aggregatedData[week] || !aggregatedData[week][agent]) {
                elements.agentInfo.style.display = 'none';
                elements.paymentStatusDisplay.style.display = 'none';
                return;
            }
            
            const adminFee = aggregatedData[week][agent];
            const paymentInfo = getPaymentInfo(agent, week);
            const paidAmount = paymentInfo ? paymentInfo.paidAmount : 0;
            const remaining = adminFee - paidAmount;
            const previousSaldo = agentSaldo[agent] || 0;
            
            // Update info display
            elements.infoAdminFee.textContent = formatCurrency(adminFee);
            elements.infoTotalPaid.textContent = formatCurrency(paidAmount);
            elements.infoRemaining.textContent = formatCurrency(remaining);
            elements.infoPreviousSaldo.textContent = formatCurrency(previousSaldo);
            
            // Set max for useSaldo (can't use more than available saldo)
            elements.useSaldo.max = Math.max(0, previousSaldo);
            elements.useSaldo.value = Math.min(elements.useSaldo.value || 0, previousSaldo);
            
            elements.agentInfo.style.display = 'block';
            
            // Update payment status
            updatePaymentStatus();
        }
        
        // Update payment status display
        function updatePaymentStatus() {
            const agent = elements.agentSelect.value;
            const week = elements.paymentWeekSelect.value;
            const paymentAmount = parseInt(elements.paymentAmount.value) || 0;
            const useSaldoAmount = parseInt(elements.useSaldo.value) || 0;
            
            if (!agent || !week || !aggregatedData[week] || !aggregatedData[week][agent]) {
                return;
            }
            
            const adminFee = aggregatedData[week][agent];
            const paymentInfo = getPaymentInfo(agent, week);
            const alreadyPaid = paymentInfo ? paymentInfo.paidAmount : 0;
            const remaining = adminFee - alreadyPaid;
            const previousSaldo = agentSaldo[agent] || 0;
            
            const totalPayment = paymentAmount + useSaldoAmount;
            const newTotalPaid = alreadyPaid + totalPayment;
            const newRemaining = adminFee - newTotalPaid;
            const newSaldo = (newTotalPaid - adminFee) + (previousSaldo - useSaldoAmount);
            
            let statusText = '';
            let statusClass = '';
            
            if (totalPayment === 0) {
                statusText = `Sisa tagihan: ${formatCurrency(remaining)}`;
                statusClass = 'info';
            } else if (newRemaining > 0) {
                statusText = `Setelah bayar: Sisa ${formatCurrency(newRemaining)}`;
                statusClass = 'partial';
            } else if (newRemaining === 0) {
                statusText = `‚úÖ Akan LUNAS setelah pembayaran`;
                statusClass = 'paid';
            } else {
                statusText = `üí∞ Akan ada saldo ${formatCurrency(Math.abs(newRemaining))}`;
                statusClass = 'overpaid';
            }
            
            // Add saldo info
            if (newSaldo !== 0) {
                statusText += `<br>Saldo akhir: <span class="${newSaldo > 0 ? 'saldo-positive' : 'saldo-negative'}">${formatCurrency(newSaldo)}</span>`;
            }
            
            elements.paymentStatusDisplay.innerHTML = statusText;
            elements.paymentStatusDisplay.className = `payment-status-display status-${statusClass}`;
            elements.paymentStatusDisplay.style.display = 'block';
        }
        
        // Render saldo section
        function renderSaldoSection() {
            // Filter agents with non-zero saldo
            const agentsWithSaldo = Object.entries(agentSaldo)
                .filter(([agent, saldo]) => saldo !== 0)
                .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));
            
            if (agentsWithSaldo.length === 0) {
                elements.saldoSection.style.display = 'none';
                return;
            }
            
            elements.saldoSection.style.display = 'block';
            
            let html = '';
            let totalSaldo = 0;
            
            agentsWithSaldo.forEach(([agent, saldo]) => {
                totalSaldo += saldo;
                
                html += `
                    <div class="agent-balance">
                        <span class="balance-label">${agent}:</span>
                        <span class="balance-value ${saldo > 0 ? 'balance-positive' : 'balance-negative'}">
                            ${formatCurrency(saldo)}
                        </span>
                    </div>
                `;
            });
            
            // Add total
            html += `
                <div class="agent-balance" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc;">
                    <span class="balance-label"><strong>Total Saldo Semua Agent:</strong></span>
                    <span class="balance-value ${totalSaldo > 0 ? 'balance-positive' : 'balance-negative'}">
                        <strong>${formatCurrency(totalSaldo)}</strong>
                    </span>
                </div>
            `;
            
            elements.saldoList.innerHTML = html;
            elements.totalSaldo.textContent = formatCurrency(totalSaldo);
        }
        
        // Render invoice table
        function renderInvoiceTable(weekData) {
            const tbody = elements.invoiceTable;
            tbody.innerHTML = '';
            
            if (weekData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #888;">
                            <i class="fas fa-inbox"></i><br>
                            Tidak ada data untuk minggu ini
                        </td>
                    </tr>
                `;
                return;
            }
            
            let totalAdmin = 0;
            let totalOrders = 0;
            let totalPaid = 0;
            let totalSaldo = 0;
            
            weekData.forEach(item => {
                totalAdmin += item.adminFee;
                totalOrders += item.totalOrder;
                totalPaid += item.paidAmount;
                totalSaldo += item.saldo;
                
                const statusText = item.status === 'paid' ? 'Lunas' : 
                                  item.status === 'partial' ? 'Sebagian' : 
                                  item.status === 'overpaid' ? 'Kelebihan' : 'Belum Bayar';
                
                const saldoClass = item.saldo > 0 ? 'saldo-positive' : 
                                 item.saldo < 0 ? 'saldo-negative' : '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.agent}</strong></td>
                    <td class="currency">${formatCurrency(item.adminFee)}</td>
                    <td class="currency">${formatCurrency(item.totalOrder)}</td>
                    <td class="currency">${formatCurrency(item.paidAmount)}</td>
                    <td><span class="status ${item.status}">${statusText}</span></td>
                    <td class="currency ${saldoClass}">${formatCurrency(item.saldo)}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Update totals
            elements.tableTotalAdmin.textContent = formatCurrency(totalAdmin);
            elements.tableTotalOrders.textContent = formatCurrency(totalOrders);
            elements.tableTotalPaid.textContent = formatCurrency(totalPaid);
            elements.tableTotalSaldo.textContent = formatCurrency(totalSaldo);
            
            // Update summary cards
            elements.totalAgents.textContent = weekData.length;
            elements.totalAdmin.textContent = formatCurrency(totalAdmin);
            elements.totalOrders.textContent = formatCurrency(totalOrders);
        }
        
        // Render payment history
        function renderPaymentHistory() {
            const container = elements.paymentHistory;
            
            // Get payments for current week
            const currentPayments = Object.values(paymentHistory)
                .filter(p => p.week === currentWeek)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (currentPayments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>Belum ada riwayat pembayaran untuk minggu ini</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="max-height: 200px; overflow-y: auto;">';
            
            currentPayments.forEach(payment => {
                const date = new Date(payment.date).toLocaleString('id-ID');
                const adminFee = aggregatedData[payment.week]?.[payment.agent] || 0;
                const status = payment.paidAmount >= adminFee ? 'Lunas' : 'Sebagian';
                const saldo = payment.paidAmount - adminFee;
                
                html += `
                    <div style="padding: 12px; margin-bottom: 10px; background: #f8f9fd; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${payment.agent}</strong>
                                <div style="font-size: 12px; color: #666;">${date}</div>
                                ${payment.notes ? `<div style="font-size: 11px; color: #888; margin-top: 2px;">üìù ${payment.notes}</div>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: #10b981; font-size: 14px;">
                                    ${formatCurrency(payment.paidAmount)}
                                </div>
                                <div style="font-size: 11px; color: #888;">
                                    <span class="status ${status === 'Lunas' ? 'paid' : 'partial'}" style="font-size: 10px;">
                                        ${status}
                                    </span>
                                    ${saldo !== 0 ? `<br><span style="font-size: 10px;">Saldo: ${formatCurrency(saldo)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Load data from Google Sheets
        async function loadData() {
            try {
                elements.dataLoading.style.display = 'block';
                elements.dashboardContent.style.display = 'none';
                
                // Load data from Google Sheets
                rawData = await parseCSVFromSheet();
                
                if (rawData.length === 0) {
                    throw new Error('Tidak ada data yang ditemukan di sheet');
                }
                
                console.log('Data loaded:', rawData.length, 'records');
                
                // Aggregate data
                aggregatedData = aggregateData(rawData);
                availableWeeks = getSortedWeeks(aggregatedData);
                
                if (availableWeeks.length === 0) {
                    throw new Error('Tidak ada data mingguan yang valid');
                }
                
                // Set current week to the latest one
                currentWeek = availableWeeks[availableWeeks.length - 1];
                
                // Load payment history
                loadPaymentHistory();
                
                // Update UI
                populateWeekDropdowns();
                populateAgentDropdown();
                renderWeekData(currentWeek);
                renderSaldoSection();
                
                elements.sheetStatus.textContent = '‚úÖ Terhubung';
                elements.sheetStatus.style.color = '#10b981';
                elements.lastUpdate.textContent = new Date().toLocaleString('id-ID');
                
                elements.dataLoading.style.display = 'none';
                elements.dashboardContent.style.display = 'block';
                
                showNotification(`‚úÖ Data berhasil dimuat: ${rawData.length} records, ${availableWeeks.length} minggu`, 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                
                elements.sheetStatus.textContent = '‚ùå Error: ' + error.message;
                elements.sheetStatus.style.color = '#ef4444';
                
                // Load sample data for demo
                loadSampleData();
                
                elements.dataLoading.style.display = 'none';
                elements.dashboardContent.style.display = 'block';
                
                showNotification(`‚ö†Ô∏è Menggunakan data sample: ${error.message}`, 'error');
            }
        }
        
        // Load sample data (fallback)
        function loadSampleData() {
            rawData = [
                { agent: "Diar", adminFee: 35000, week: "18-24 Jan 2025" },
                { agent: "Restu", adminFee: 45000, week: "18-24 Jan 2025" },
                { agent: "Fajar", adminFee: 52000, week: "18-24 Jan 2025" },
                { agent: "Kharisma", adminFee: 28000, week: "18-24 Jan 2025" },
                { agent: "Agung", adminFee: 38000, week: "18-24 Jan 2025" },
                { agent: "Defita", adminFee: 42000, week: "18-24 Jan 2025" },
                { agent: "Diar", adminFee: 40000, week: "25-31 Jan 2025" },
                { agent: "Restu", adminFee: 50000, week: "25-31 Jan 2025" },
                { agent: "Fajar", adminFee: 55000, week: "25-31 Jan 2025" },
                { agent: "Kharisma", adminFee: 32000, week: "25-31 Jan 2025" },
                { agent: "Agung", adminFee: 42000, week: "25-31 Jan 2025" },
                { agent: "Defita", adminFee: 48000, week: "25-31 Jan 2025" },
                { agent: "Lutfi Majid", adminFee: 31000, week: "25-31 Jan 2025" },
                { agent: "Akhmad Rifki", adminFee: 24000, week: "25-31 Jan 2025" }
            ];
            
            aggregatedData = aggregateData(rawData);
            availableWeeks = getSortedWeeks(aggregatedData);
            currentWeek = availableWeeks[availableWeeks.length - 1];
            
            // Add some sample payment history with overpayment
            paymentHistory = {
                "Diar_25-31 Jan 2025": { agent: "Diar", week: "25-31 Jan 2025", paidAmount: 50000, notes: "Bayar lebih", date: "2025-01-30T10:00:00" },
                "Restu_25-31 Jan 2025": { agent: "Restu", week: "25-31 Jan 2025", paidAmount: 30000, notes: "DP", date: "2025-01-29T14:30:00" },
                "Fajar_25-31 Jan 2025": { agent: "Fajar", week: "25-31 Jan 2025", paidAmount: 60000, notes: "Bayar lebih banyak", date: "2025-01-28T16:45:00" }
            };
            
            localStorage.setItem('agent_payment_history', JSON.stringify(paymentHistory));
            
            loadPaymentHistory();
            populateWeekDropdowns();
            populateAgentDropdown();
            renderWeekData(currentWeek);
            renderSaldoSection();
            
            elements.lastUpdate.textContent = new Date().toLocaleString('id-ID') + ' (Sample Data)';
        }
        
        // Render data for specific week
        function renderWeekData(week) {
            currentWeek = week;
            elements.selectedWeek.textContent = week;
            
            const weekData = getWeekData(week);
            renderInvoiceTable(weekData);
            renderPaymentHistory();
            renderSaldoSection();
            
            // Update agent dropdown for this week
            populateAgentDropdown();
        }
        
        // Refresh data
        function refreshData() {
            const selectedWeek = elements.weekSelect.value;
            if (selectedWeek) {
                renderWeekData(selectedWeek);
                showNotification(`Data untuk periode ${selectedWeek} diperbarui`, 'success');
            }
        }
        
        // Submit payment
        async function submitPayment() {
            const agent = elements.agentSelect.value;
            const week = elements.paymentWeekSelect.value;
            const paymentAmount = parseInt(elements.paymentAmount.value) || 0;
            const useSaldoAmount = parseInt(elements.useSaldo.value) || 0;
            const notes = elements.paymentNotes.value;
            
            // Validation
            if (!agent || !week) {
                showNotification('Harap pilih agent dan week!', 'error');
                return;
            }
            
            if (paymentAmount === 0 && useSaldoAmount === 0) {
                showNotification('Harap isi jumlah pembayaran atau gunakan saldo!', 'error');
                return;
            }
            
            // Check if agent exists in selected week
            if (!aggregatedData[week] || !aggregatedData[week][agent]) {
                showNotification('Agent tidak ditemukan di minggu yang dipilih!', 'error');
                return;
            }
            
            const totalAdmin = aggregatedData[week][agent];
            const totalPayment = paymentAmount + useSaldoAmount;
            
            // Show confirmation for overpayment
            const paymentInfo = getPaymentInfo(agent, week);
            const alreadyPaid = paymentInfo ? paymentInfo.paidAmount : 0;
            const newTotalPaid = alreadyPaid + totalPayment;
            
            if (newTotalPaid > totalAdmin * 1.2) { // 20% lebih dari tagihan
                const confirmOverpay = confirm(
                    `Pembayaran akan melebihi tagihan:\n\n` +
                    `Tagihan: ${formatCurrency(totalAdmin)}\n` +
                    `Sudah dibayar: ${formatCurrency(alreadyPaid)}\n` +
                    `Pembayaran baru: ${formatCurrency(totalPayment)}\n` +
                    `Total akan jadi: ${formatCurrency(newTotalPaid)}\n\n` +
                    `Apakah Anda yakin? Kelebihan akan jadi saldo.`
                );
                if (!confirmOverpay) return;
            }
            
            // Show loading
            elements.loading.style.display = 'block';
            elements.submitPaymentBtn.disabled = true;
            elements.submitPaymentBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            
            try {
                // Prepare data for Google Sheets
                const paymentData = {
                    agent: agent,
                    week: week,
                    payment_amount: paymentAmount,
                    use_saldo: useSaldoAmount,
                    total_payment: totalPayment,
                    notes: notes || '',
                    total_admin: totalAdmin,
                    previous_saldo: agentSaldo[agent] || 0,
                    new_saldo: (newTotalPaid - totalAdmin) + (agentSaldo[agent] || 0) - useSaldoAmount,
                    timestamp: new Date().toISOString(),
                    source: 'Dashboard Payment'
                };
                
                // Send to Google Sheets via Apps Script
                const params = new URLSearchParams(paymentData);
                const url = `${APPS_SCRIPT_URL}?${params.toString()}`;
                
                console.log('Sending to Google Sheets:', url);
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    // Save to localStorage
                    savePayment(agent, week, totalPayment, notes);
                    
                    // Update UI
                    renderWeekData(currentWeek);
                    renderPaymentHistory();
                    renderSaldoSection();
                    
                    // Clear form
                    elements.paymentAmount.value = '';
                    elements.useSaldo.value = '0';
                    elements.paymentNotes.value = '';
                    elements.agentInfo.style.display = 'none';
                    elements.paymentStatusDisplay.style.display = 'none';
                    
                    // Show success message with saldo info
                    const newSaldo = agentSaldo[agent] || 0;
                    let message = `‚úÖ Pembayaran ${formatCurrency(totalPayment)} berhasil disimpan!`;
                    
                    if (newSaldo > 0) {
                        message += `\nüí∞ ${agent} sekarang punya saldo ${formatCurrency(newSaldo)}`;
                    } else if (newSaldo < 0) {
                        message += `\n‚ö†Ô∏è ${agent} masih punya tunggakan ${formatCurrency(Math.abs(newSaldo))}`;
                    }
                    
                    showNotification(message, 'success');
                    
                } else {
                    throw new Error(result.message || 'Gagal menyimpan ke Google Sheets');
                }
                
            } catch (error) {
                console.error('Error saving payment:', error);
                
                // Fallback: save to localStorage only
                savePayment(agent, week, totalPayment, notes);
                renderWeekData(currentWeek);
                renderPaymentHistory();
                renderSaldoSection();
                
                showNotification(`‚ö†Ô∏è Disimpan lokal: ${error.message}`, 'info');
                
            } finally {
                // Hide loading
                elements.loading.style.display = 'none';
                elements.submitPaymentBtn.disabled = false;
                elements.submitPaymentBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Pembayaran';
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load data on page load
            loadData();
            
            // Add event listener for week change
            elements.weekSelect.addEventListener('change', function() {
                if (this.value) {
                    renderWeekData(this.value);
                }
            });
        });
    </script>
</body>
</html>
